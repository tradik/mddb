name: Docker Build and Push

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_HUB_USERNAME: tradik
  IMAGE_NAME: mddb

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          # Get version from tag or use 'latest' for main branch
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION_NUM=${VERSION#v}
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
            echo "VERSION_NUM=${VERSION_NUM}" >> $GITHUB_OUTPUT
            echo "IS_RELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "VERSION=latest" >> $GITHUB_OUTPUT
            echo "VERSION_NUM=latest" >> $GITHUB_OUTPUT
            echo "IS_RELEASE=false" >> $GITHUB_OUTPUT
          fi
          
          # Get commit SHA (short)
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          
          # Get build date
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push server image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./services/mddbd/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.VERSION_NUM }}
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=MDDB Server
            org.opencontainers.image.description=High-performance markdown database server with gRPC and HTTP/3 support
            org.opencontainers.image.version=${{ steps.meta.outputs.VERSION_NUM }}
            org.opencontainers.image.created=${{ steps.meta.outputs.BUILD_DATE }}
            org.opencontainers.image.revision=${{ steps.meta.outputs.COMMIT_SHA }}
            org.opencontainers.image.source=https://github.com/tradik/mddb
            org.opencontainers.image.url=https://github.com/tradik/mddb
            org.opencontainers.image.documentation=https://github.com/tradik/mddb/blob/main/README.md
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.vendor=MDDB Team
          cache-from: type=registry,ref=${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
          build-args: |
            VERSION=${{ steps.meta.outputs.VERSION }}
            BUILD_DATE=${{ steps.meta.outputs.BUILD_DATE }}
            COMMIT_SHA=${{ steps.meta.outputs.COMMIT_SHA }}

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          repository: ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}
          readme-filepath: ./docs/DOCKER_HUB.md
          short-description: "High-performance markdown database with gRPC/HTTP/3 - 29,810 docs/sec, 5.75x faster than MongoDB"

      - name: Create release summary
        if: steps.meta.outputs.IS_RELEASE == 'true'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ³ Docker Images Published
          
          ### Production Images
          - `${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.VERSION_NUM }}`
          - `${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest`
          
          ### Platforms
          - `linux/amd64` (Intel/AMD)
          - `linux/arm64` (ARM/Apple Silicon)
          
          ### Quick Start
          ```bash
          docker pull ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.VERSION_NUM }}
          docker run -d -p 11023:11023 -p 11024:11024 \
            -v mddb-data:/data \
            -e MDDB_EXTREME=true \
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.VERSION_NUM }}
          ```
          
          ### Links
          - [Docker Hub](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }})
          - [GitHub Release](https://github.com/tradik/mddb/releases/tag/${{ steps.meta.outputs.VERSION }})
          - [Documentation](https://github.com/tradik/mddb)
          EOF
